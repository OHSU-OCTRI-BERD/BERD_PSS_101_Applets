---
title: "One Sample T test: Visulization + applet prep"
author: "Will Baker-Robinson"
date: "10/12/2020"
output:
  html_document:
    number_sections: yes
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(glue)
library(ggplot2)
library(dplyr)
library(tidyr)

#User defined functions specified in functions.r
source("functions.r")
```

Hypotheses: $H_0: \mu_0 = \mu_A$ vs. $H_A: \mu_0 \ne \mu_A$  
Alpha: This will be a variable that the user can set but default to 0.05   
$\mu_0:$ Population mean under the null hypothesis.  
$\mu_A:$ Anticipated population mean under the alternative hypothesis.  
sigma: Anticipated standard deviation of the population  
$s \in (0, \infty)$
Effect size: $\frac{|\mu_0-\mu_A|}{s}$  
Calculate: Power or Sample size, pick one  
Power: Probability of rejecting the null given the alternative is true. 
$S \in (0,1)$  
Sample size: # of participants required to attain a certain power.  
$n \in \{1,...\}$  

# Hypothesis Distribution Graphs

```{r distribution n & mu0 / muA or dif given}
# Parameters
alpha <- 0.05
mu0 <- 0
muA <- 1 
sd <- 2
pop_sd <- FALSE
effect_size <- abs(mu0 - muA)/sd
power <- NA
N <- 50
df <- N-1
two_sided = TRUE # default
test_stat <- calc_test_stat(df, alpha, two_sided)
ncp <- (muA - mu0) * sqrt(N)/sd
data <- tibble(x_val = seq(from = -3.5*(df/(df-2)), 
                           to = ncp + ifelse(ncp > 4, ncp + 1, 3.5)*(df/(df-2)), 
                           by = 0.01),
               pdf_h0 = dt(x_val, df),
               pdf_hA = dt(x_val, df, ncp)) %>%
   filter(!(x_val < 0 & pdf_h0 < 0.001) & !(x_val > ncp & pdf_hA < 0.001)) # will maybe make slightly more efficient?

# max of pdf_h0 stored here so I don't call it 3x in ggplot fx
max_h0 <- max(data$pdf_h0)

# 1 sample T test power plot w/ sample size given
ggplot(data) + 
  geom_area(mapping = aes(y = ifelse(x_val < -test_stat | x_val > test_stat, pdf_h0, 0), 
                          x= x_val, 
                          fill = "Type I Error (alpha)")) +
  geom_area(mapping = aes(y = ifelse(x_val < test_stat, pdf_hA, 0), 
                          x= x_val, 
                          fill = "Type II Error (Beta)")) +
  geom_ribbon(data %>% filter(x_val <= test_stat & x_val >= -test_stat), 
              mapping = aes(ymax = ifelse(pdf_h0 < pdf_hA, pdf_hA, pdf_h0), 
                            ymin = pdf_hA, 
                            x = x_val, 
                            fill = "True Negative")) +
  geom_ribbon(data %>% filter(x_val >= test_stat), 
              mapping = aes(ymin = pdf_h0, 
                            ymax = ifelse(pdf_hA < pdf_h0, pdf_h0, pdf_hA), 
                            x = x_val, 
                            fill = "Power")) +
  geom_ribbon(data %>% filter(x_val <= -test_stat), 
              mapping = aes(ymin = 0, 
                  ymax = pdf_hA, 
                  x = x_val, 
                  fill = "Power")) +
  geom_line(data %>% filter(!(pdf_h0 < 0.001 & x_val > 0)),
            mapping = aes(x = x_val,
                          y = pdf_h0),
            color = "#999999",
            lty = "dashed") +
  geom_segment(aes(x = -test_stat, 
                   y = 0, 
                   xend = -test_stat, 
                   yend = max_h0),
               alpha = 0.7,
               color = "#999999") + 
  geom_segment(aes(x = test_stat, 
                   y = 0, xend = test_stat, 
                   yend = max_h0), 
               alpha = 0.7,
               color = "#999999") + 
  labs(y = "Value of Probability Density Function",
       x = "Value of T statistic",
       title = "Traditional Power Visualization: 1 Sample T-test") +
  annotate("text", x = 0, y = max(data$pdf_h0) + 0.01, label = glue("H0")) +
  annotate("text", x = data[[which.max(data$pdf_hA),1]], y = max(data$pdf_hA) + 0.01, label = glue("HA")) +
  annotate("text", x = -test_stat, y = max_h0 + 0.01, label = glue("-Tcrit")) +
  annotate("text", x = test_stat, y = max_h0 + 0.01, label = glue("+Tcrit")) +
  theme_bw() + # will create my own theme eventually
  scale_fill_manual(name = "Area Represents:", values = c("#0072B2", "#CCCCCC", "#E69F00", "#F0E442")) +
  theme(legend.position="bottom")
```


```{r distribution power & mu0/ muA or dif given}
# Parameters
# alpha <- 0.05
# mu0 <- 0
# muA <- 1
# sd <- 1
# effect_size <- abs(mu0 - muA)/sd
# power <- 0.80
# N <- NA
# # solve for N & df then more or less same plot as above
```

# Power Graphs

```{r power graph with dif alpha levels}
pow_2_side <- ifelse(two_sided, 1, 2)
alternative <- c("two.sided", "one.sided")
alpha_presets <- c(0.01, 0.05, 0.10)
alpha <- 0.05
user_power <- power.t.test(N, abs(mu0-muA), sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]]
user_N <- N
if(alpha %in% alpha_presets)
  {
  power_data <- tibble(N = seq(5, N + 5, 1),
                       alpha0.01 = power.t.test(N, abs(mu0-muA), sd, sig.level = 0.01, alternative = alternative[pow_2_side])[["power"]],
                       alpha0.05 = power.t.test(N, abs(mu0-muA), sd, sig.level = 0.05, alternative = alternative[pow_2_side])[["power"]],
                       alpha0.10 = power.t.test(N, abs(mu0-muA), sd, sig.level = 0.10, alternative = alternative[pow_2_side])[["power"]])
  } else
    {
      power_data <- tibble(N = seq(5, N + 5, 1),
                       alpha0.01 = power.t.test(N, abs(mu0-muA), sd, sig.level = 0.01, alternative = alternative[pow_2_side])[["power"]],
                       alpha0.05 = power.t.test(N, abs(mu0-muA), sd, sig.level = 0.05, alternative = alternative[pow_2_side])[["power"]],
                       alpha0.10 = power.t.test(N, abs(mu0-muA), sd, sig.level = 0.10, alternative = alternative[pow_2_side])[["power"]],
                       user_alpha = power.t.test(N, abs(mu0-muA), sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]]) %>%
      rename(!!paste0("alpha", alpha) := user_alpha)
    }
power_data <- power_data %>%
  pivot_longer(starts_with("alpha"),
               names_prefix = "alpha",
               values_to = "power",
               names_to = "alpha_level") %>%
  # Maybe remove user_alpha? RN just an extra var. May use in future if I want to add a legend for shape.
  mutate(alpha_level = factor(alpha_level),
         user_alpha = ifelse(alpha == alpha_level, TRUE, FALSE))

power_data_non_user <- power_data %>%
  filter(alpha != alpha_level)

power_data_user <- power_data %>%
  filter(alpha == alpha_level)

label_non_user <- power_data_non_user %>%
  group_by(alpha_level) %>%
  summarize(max = max(power))

ggplot() +
   geom_segment(aes(x = user_N,
                   y = 0,
                   xend = user_N,
                   yend = user_power),
               alpha = 0.5,
               color = "#0072B2",
               lty = "dashed") + 
  geom_segment(aes(x = 0,
                   y = user_power,
                   xend = user_N,
                   yend = user_power),
               alpha = 0.5,
               color = "#0072B2",
               lty = "dashed") + 
  # Color for non-user entered
  geom_point(power_data_non_user, mapping = aes(x = N, y = power, color = alpha_level), shape = 16) +
  geom_line(power_data_non_user, mapping = aes(x = N, y = power, group = alpha_level, color = alpha_level)) +
  # Color for user entered
  geom_point(power_data_user, mapping = aes(x = N, y = power), shape = 17, color = "#E69F00") +
  geom_line(power_data_user, mapping = aes(x = N, y = power), color = "#E69F00") +
  geom_point(power_data, mapping = aes(x = user_N, y = user_power), color = "#0072B2", shape = 17) +
  geom_text(label_non_user, mapping = aes(x = user_N + 6.5, y = max, label = alpha_level, color = alpha_level)) +
  geom_text(power_data_user, mapping = aes(x = user_N + 6.5, y = max(power), label = alpha_level), color = "#E69F00") +
  theme_bw() +
  labs(x = "Sample Size",
       y = "Power",
       title = "Power Curve: 1 sample T-test by alpha level",
       subtitle = "User specified alpha in orange with (N, power) in blue") +
  theme(legend.position="none") +
  scale_color_grey()
```

```{r power graph with dif effect sizes}
pow_2_side <- ifelse(two_sided, 1, 2)
alternative <- c("two.sided", "one.sided")
std_effect <- c(0.2, 0.5, 0.8)
delta_vals <- std_effect*sd
alpha <- 0.05
delta <- abs(mu0-muA)
user_power <- power.t.test(N, user_delta, sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]]
user_N <- N
if(delta %in% delta_vals)
  {
  power_data <- tibble(N = seq(5, N + 5, 1),
                       !!paste0("delta", delta_vals[1]) := power.t.test(N, delta_vals[1], sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]],
                       !!paste0("delta", delta_vals[2]) := power.t.test(N, delta_vals[2], sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]],
                       !!paste0("delta", delta_vals[3]) := power.t.test(N, delta_vals[3], sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]])
  } else
    {
      power_data <- tibble(N = seq(5, N + 5, 1),
                       !!paste0("delta", delta_vals[1]) := power.t.test(N, delta_vals[1], sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]],
                       !!paste0("delta", delta_vals[2]) := power.t.test(N, delta_vals[2], sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]],
                       !!paste0("delta", delta_vals[3]) := power.t.test(N, delta_vals[3], sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]],
                       user_delta = power.t.test(N, delta, sd, sig.level = alpha, alternative = alternative[pow_2_side])[["power"]]) %>%
      rename(!!paste0("delta", delta) := user_delta)
    }
power_data <- power_data %>%
  pivot_longer(starts_with("delta"),
               names_prefix = "delta",
               names_transform = list("delta_val" = as.double),
               values_to = "power",
               names_to = "delta_val") %>%
  mutate(effect = factor(delta_val/sd))

power_data_non_user <- power_data %>%
  filter(delta != delta_val) %>%
  select(-delta_val)

power_data_user <- power_data %>%
  filter(delta == delta_val) %>%
  select(-delta_val)

label_non_user <- power_data_non_user %>%
  group_by(effect) %>%
  summarize(max = max(power))

ggplot() +
   geom_segment(aes(x = user_N,
                   y = 0,
                   xend = user_N,
                   yend = user_power),
               alpha = 0.5,
               color = "#0072B2",
               lty = "dashed") + 
  geom_segment(aes(x = 0,
                   y = user_power,
                   xend = user_N,
                   yend = user_power),
               alpha = 0.5,
               color = "#0072B2",
               lty = "dashed") + 
  # Color for non-user entered
  geom_point(power_data_non_user, mapping = aes(x = N, y = power, color = effect), shape = 16) +
  geom_line(power_data_non_user, mapping = aes(x = N, y = power, group = effect, color = effect)) +
  # Color for user entered
  geom_point(power_data_user, mapping = aes(x = N, y = power), shape = 17, color = "#E69F00") +
  geom_line(power_data_user, mapping = aes(x = N, y = power), color = "#E69F00") +
  geom_point(power_data, mapping = aes(x = user_N, y = user_power), color = "#0072B2", shape = 17) +
  geom_text(label_non_user, mapping = aes(x = user_N + 6.5, y = max, label = effect, color = effect)) +
  geom_text(power_data_user, mapping = aes(x = user_N + 6.5, y = max(power), label = effect), color = "#E69F00") +
  theme_bw() +
  labs(x = "Sample Size",
       y = "Power",
       title = "Power Curve: 1 sample T-test by effect size",
       subtitle = "User specified effect size in orange with (N, power) in blue") +
  theme(legend.position="none") +
  scale_color_grey()
```

